<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.StatementDao">
	<!-- 添加购物车信息 -->
	<select id="queryCategoryList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select cate_id,cate_name,cate_superior,cate_weight from category_tab
		where 1=1
		<if test="cate_id!=null">
			and cate_superior = #{cate_id}
		</if>
		<if test="cate_superior == null and cate_id == null">
			and cate_superior isnull
		</if>
		order by cate_weight desc
	</select>
	<!-- 查询商品销量 -->
	<select id="queryCommoditySales" resultType="java.util.HashMap" >
		select count(sale_id),sum(to_number(sal.real_price, '99999999999999999.99')),o.sell_type from  sales_record_tab sal left join order_tab o on sal.orde_id = o.orde_id
		left join commodity_tab c on sal.comm_id = c.comm_putaway_id
		where chan_id isnull
		and (orde_status!='撤销' and orde_status!='创建') and c.comm_model = #{comm_model} 
		<if test="start_date!=null">
			and o.orde_date >= to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="ending_date!=null">
			and o.orde_date &lt;= to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		group by o.sell_type
	</select>
	<!-- 查询商品型号 -->
	<select id="queryCommodityModel" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select comm_putaway_id,comm_model,offline_price from commodity_tab c left join category_tab tab on c.comm_cate_id = tab.cate_id where cate_id =#{cate_id};
	</select>
	<!-- 查询库存量信息 -->
	<select id="queryStockList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select sum(stoc_count)stoc_count,sum(lock_count)lock_count,sum(scrap_count)scrap_count,sum(ship_count)ship_count,sum(sample_count)sample_count from stock_tab where comm_id = #{comm_putaway_id}
	</select>
	<!-- 总实例查询商品销售信息 -->
	<resultMap type="com.entity.PullStatementSumList" id="PullStatementSumList_id">
		<result property="sell_type" column="sell_type" />
		<result property="count" column="count" />
		<result property="sum" column="sum" />
	</resultMap>
	<resultMap type="com.entity.PullStatementComm" id="PullStatementComm_id">
		<result property="comm_model" column="comm_model" />
		<collection property="sumList" resultMap="PullStatementSumList_id"></collection>
	</resultMap>
	<resultMap type="com.entity.PullStatement" id="PullStatement_id">
		<result property="cate_name" column="cate_name" />
		<collection property="commModelList" resultMap="PullStatementComm_id"></collection>
	</resultMap>
	<select id="queryPullStatements" resultMap="PullStatement_id" parameterType="java.util.HashMap">
		select count(sale_id),sum(to_number(sal.real_price, '99999999999999999.99')),cate_name,comm_model,sell_type from 
		category_tab tab2
		left join commodity_tab tab on tab.comm_cate_id = tab2.cate_id
		left join sales_record_tab sal on sal.comm_id = tab.comm_putaway_id
		left join order_tab o on sal.orde_id = o.orde_id
		where 1=1 and sal.chan_id isnull
		and (orde_status!='撤销' and orde_status!='创建') group by cate_name,comm_model,o.sell_type
		<if test="start_date!=null">
			and o.orde_date >= to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="ending_date!=null">
			and o.orde_date &lt;= to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
	</select>
	<!-- 总实例查询品类信息 -->
	<select id="queryPullStatementsCate" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select cat1.cate_name cate_name1,com1.comm_model comm_model1,cat2.cate_name cate_name2,com2.comm_model comm_model2 from category_tab cat1 left join category_tab cat2 on cat1.cate_id = cat2.cate_superior
		left join commodity_tab com2 on cat2.cate_id = com2.comm_cate_id
		left join commodity_tab com1 on cat1.cate_id = com1.comm_cate_id
		where cat1.cate_superior isnull
	</select>
	<!-- 查询商品销量信息 -->
	<select id="queryPullCateModeSalelList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select count(sal.sale_id),o.sell_type,sum(to_number(sal.real_price, '99999999999999999.99')) from sales_record_tab sal
		left join commodity_tab com on sal.comm_id = com.comm_putaway_id
		left join order_tab o on sal.orde_id = o.orde_id
		where comm_model =#{comm_model} and sal.chan_id isnull
		and (o.orde_status!='撤销' and o.orde_status!='创建')
		<if test="start_date!=null">
			and o.orde_date >= to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="ending_date!=null">
			and o.orde_date &lt;= to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		group by o.sell_type
	</select>
	<!-- 总实例查询子实例库存信息 -->
	<select id="queryPullStockList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select sum(stoc_count) stoc_count,sum(lock_count) lock_count,sum(scrap_count) scrap_count,sum(ship_count) ship_count,sum(sample_count) from stock_tab sto
		left join commodity_tab com on sto.comm_id = com.comm_putaway_id where com.comm_model =#{comm_model}
	</select>
	<!-- 分实例查询自己进货记录 -->
	<select id="queryPurchasesList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select count(inve_alter_id) sum,to_char(inve_alter_date,'yyyy-mm-dd') inve_alter_date from inventory_alter_tab inv
		left join commodity_tab com on inv.comm_id = com.comm_putaway_id
		where inve_alter_cause = '采购入库' and comm_model=#{comm_model} 
		<if test="start_date!=null">
			and inve_alter_date >= to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="ending_date!=null">
			and inve_alter_date &lt;= to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		group by to_char(inve_alter_date,'yyyy-mm-dd') order by inve_alter_date asc 
	</select>
	<!-- 子实例提供给总实例查询商品销售记录 -->
	<select id="queryOfferSalesRecordList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select tab.sell_type,sum(tab.count),tab.date from (select count(sal.sale_id),position(sell_type in '线上') sell_type,to_char(o.orde_date,'yyyy-mm-dd') date
		from sales_record_tab sal
		left join commodity_tab com on sal.comm_id = com.comm_putaway_id
		left join order_tab o on sal.orde_id = o.orde_id
		where comm_model = #{comm_model} and o.orde_date >=to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss') and o.orde_date &lt;=to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		and (o.orde_status!='撤销' and o.orde_status!='创建') and sal.chan_id isnull group by o.sell_type,date)tab group by tab.sell_type,tab.date order by tab.date asc
	</select>
	<!-- 自实例查询入库记录数据 -->
	<select id="queryPurchasePutCount" resultType="int" parameterType="java.util.HashMap">
		select count(inve_alter_id) from inventory_alter_tab inv
		left join commodity_tab com on inv.comm_id = com.comm_putaway_id
		where inve_alter_cause='采购入库'
		and com.comm_model=#{comm_model}
		<if test="start_date!=null">
			and inve_alter_date >= to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="ending_date!=null">
			and inve_alter_date &lt;= to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
	</select>
	<!-- 自实例查询出库数量 -->
	<select id="queryStockRemovalCount" resultType="int" parameterType="java.util.HashMap">
		select count(inve_id) from inventory_detail_tab inv
		left join commodity_tab com on inv.comm_id = com.comm_putaway_id
		where inve_come_sign='C'
		and com.comm_model=#{comm_model}
		<if test="start_date!=null">
			and inve_come_date >= to_timestamp(#{start_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="ending_date!=null">
			and inve_come_date &lt;= to_timestamp(#{ending_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
	</select>
	<!-- 自实例根据商品型号查询库存信息 -->
	<select id="queryModelStockList" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select sum(stoc_count)stoc_count,sum(lock_count)lock_count,sum(scrap_count)scrap_count,sum(ship_count)ship_count,sum(sample_count)sample_count from stock_tab sto
		left join commodity_tab com on sto.comm_id = com.comm_putaway_id
		where com.comm_model = #{comm_model}
	</select>
</mapper>