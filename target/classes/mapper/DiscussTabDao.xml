<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.DiscussTabDao">
	<!-- 添加评论信息 -->
	<insert id="addDiscussTab" parameterType="com.entity.DiscussTab">
		INSERT INTO discuss_tab(buye_id,orde_id,disc_content,disc_cont_date
		<if test="disc_comm_grade!=null">
			,disc_comm_grade
		</if>
		<if test="disc_deli_grade!=null">
			,disc_deli_grade
		</if>
		<if test="disc_inst_grade!=null">
			,disc_inst_grade
		</if>
		<if test="disc_reply!=null">
			,disc_reply
		</if>
		<if test="disc_reply_date!=null">
			,disc_reply_date
		</if>
		<if test="disc_staff_id!=null">
			,disc_staff_id
		</if>
		) VALUES (#{buye_id},#{orde_id},#{disc_content},now()
		<if test="disc_comm_grade!=null">
			,#{disc_comm_grade}
		</if>
		<if test="disc_deli_grade!=null">
			,#{disc_deli_grade}
		</if>
		<if test="disc_inst_grade!=null">
			,#{disc_inst_grade}
		</if>
		<if test="disc_reply!=null">
			,#{disc_reply}
		</if>
		<if test="disc_reply_date!=null">
			,to_timestamp(#{disc_reply_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="disc_staff_id!=null">
			,#{disc_staff_id}
		</if>
		)
	</insert>
	<!-- 查询评论信息 -->
	<select id="queryDiscussTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select * from
		(select distinct disc_id,st.staf_name,buye_phone,disc_comm_id,disc_comm_putaway_id,dis.buye_id,dis.orde_id,disc_comm_grade,disc_deli_grade,disc_inst_grade,disc_content,disc_reply,to_char(disc_cont_date,'yyyy-mm-dd hh24:mi:ss')disc_cont_date,to_char(disc_reply_date,'yyyy-mm-dd hh24:mi:ss')disc_reply_date,disc_staff_id from discuss_tab dis
		left join buyer_tab tab on dis.buye_id = tab.buye_id
		left join order_tab o on dis.orde_id = o.orde_id
		left join sales_record_tab sal on sal.orde_id=o.orde_id
		left join commodity_tab tab2 on sal.comm_id = tab2.comm_putaway_id
		left join staff_tab st on dis.disc_staff_id = st.staf_id
		WHERE 1=1
		<if test="comm_id!=null">
			and sal.comm_id = #{comm_id}
		</if>
		<if test="disc_id!=null">
			and dis.disc_id = #{disc_id}
		</if>
		<if test="disc_comm_id!=null">
			and sal.comm_id = #{disc_comm_id}
		</if>
		<if test="disc_comm_putaway_id!=null">
			and dis.disc_comm_putaway_id = #{disc_comm_putaway_id}
		</if>
		<if test="buye_id!=null">
			and disc.buye_id = #{buye_id}
		</if>
		<if test="orde_id!=null">
			and dis.orde_id = #{orde_id}
		</if>
		<if test="disc_staff_id!=null">
			and dis.disc_staff_id = #{disc_staff_id}
		</if>
		) dis	
		order by dis.disc_cont_date desc
		LIMIT #{page} OFFSET #{nums}	
	</select>
	<!-- 查询配置地址总数 -->
	<select id="queryDiscussTabCount" parameterType="java.util.HashMap" resultType="int">
		select count(distinct dis.disc_id) from discuss_tab dis
		left join buyer_tab tab on dis.buye_id = tab.buye_id
		left join order_tab o on dis.orde_id = o.orde_id
		left join sales_record_tab sal on sal.orde_id=o.orde_id
		left join commodity_tab tab2 on sal.comm_id = tab2.comm_putaway_id
		left join staff_tab st on dis.disc_staff_id = st.staf_id
		WHERE 1=1		
		<if test="comm_id!=null">
			and sal.comm_id = #{comm_id}
		</if>
		<if test="disc_id!=null">
			and dis.disc_id = #{disc_id}
		</if>
		<if test="disc_comm_id!=null">
			and dis.disc_comm_id = #{disc_comm_id}
		</if>
		<if test="disc_comm_putaway_id!=null">
			and dis.disc_comm_putaway_id = #{disc_comm_putaway_id}
		</if>
		<if test="buye_id!=null">
			and disc.buye_id = #{buye_id}
		</if>
		<if test="orde_id!=null">
			and dis.orde_id = #{orde_id}
		</if>
		<if test="disc_staff_id!=null">
			and dis.disc_staff_id = #{disc_staff_id}
		</if> 	
	</select>
	<!-- 更新评论信息 -->
	<update id="updateDiscussTab" parameterType="com.entity.DiscussTab">
		UPDATE discuss_tab 
		<trim prefix="set" suffixOverrides=",">
			<if test="disc_comm_grade!=null">
				disc_comm_grade=#{disc_comm_grade},
			</if>
			<if test="disc_deli_grade!=null">
				disc_deli_grade=#{disc_deli_grade},
			</if>
			<if test="disc_inst_grade!=null">
				disc_inst_grade=#{disc_inst_grade},
			</if>
			<if test="disc_content!=null">
				disc_content=#{disc_content},
			</if>
			<if test="disc_reply!=null">
				disc_reply=#{disc_reply},
			</if>
			<if test="disc_cont_date!=null">
				disc_cont_date=to_timestamp(#{disc_cont_date},'yyyy-mm-dd hh24:mi:ss'),
			</if>
			<if test="disc_reply_date!=null">
				disc_reply_date=to_timestamp(#{disc_reply_date},'yyyy-mm-dd hh24:mi:ss'),
			</if>
			<if test="disc_staff_id!=null">
				disc_staff_id=#{disc_staff_id},
			</if>
		</trim> 
		WHERE disc_id =#{disc_id}
	</update>
	<!-- 删除评论信息 -->
	<delete id="deleteDiscussTab" parameterType="int">
		DELETE FROM discuss_tab WHERE disc_id=#{disc_id}
	</delete>
</mapper>