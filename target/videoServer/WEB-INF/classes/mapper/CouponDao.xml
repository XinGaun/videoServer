<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.CouponDao">
	<resultMap type="com.entity.Coupon" id="couponEntity">
		<id property="discountsId" column="discounts_id" jdbcType="NUMERIC"/>
		<result property="discountsText" column="discounts_text" jdbcType="VARCHAR"/>
		<result property="discountsNumber" column="discounts_number" jdbcType="VARCHAR"/>
		<result property="discountsDateString" column="discounts_date" jdbcType="VARCHAR"/>
		<result property="discountsValid" column="discounts_valid" jdbcType="NUMERIC"/>
		<result property="discountsAddr" column="discounts_addr" jdbcType="VARCHAR"/>
	</resultMap>
	<resultMap type="com.entity.UseCoupon" id="useCouponEntity">
		<result property="userId" column="user_id" jdbcType="NUMERIC"/>
		<result property="DiscountsId" column="discounts_id" jdbcType="NUMERIC"/>
		<result property="videoId" column="video_id" jdbcType="NUMERIC"/>
		<result property="comboId" column="combo_id" jdbcType="NUMERIC"/>
		<result property="discountsDateString" column="discounts_date" jdbcType="VARCHAR"/>
	</resultMap>
	<sql id="coupon_column">
		discounts_id,discounts_text,discounts_number,date_format(discounts_date,'%Y-%m-%d %h:%i:%s') discounts_date,discounts_valid,discounts_addr
	</sql>
	<sql id="discounts_use_column">
		user_id,discounts_id,video_id,combo_id,date_format(discounts_date,'%Y-%m-%d %h:%i:%s') discounts_date
	</sql>
	<select id="queryCoupon" parameterType="com.entity.Coupon" resultMap="couponEntity">
		select <include refid="coupon_column"/> from discounts_tab
		<where>
			<if test="discountsId != null and discountsId != ''">
				discounts_id = #{discountsId}
			</if>
			<if test="discountsText != null and discountsText != ''">
				AND discounts_text = #{discountsText}
			</if>
			<if test="discountsNumber != null and discountsNumber != ''">
				AND discounts_number = #{discountsNumber}
			</if>
			<if test="discountsDate != null and discountsDate != ''">
				AND discounts_date = #{discountsDate}
			</if>
			<if test="discountsValid != null and discountsValid != ''">
				AND discounts_valid = #{discountsValid}
			</if>
			<if test="discountsAddr != null and discountsAddr != ''">
				AND discounts_addr = #{discountsAddr}
			</if>
		</where>
	</select>
	<select id="queryCouponCount" resultType="java.lang.Integer">
		select count(discounts_id) from discounts_tab
		<where>
			<if test="discountsId != null and discountsId != ''">
				discounts_id = #{discountsId}
			</if>
			<if test="discountsText != null and discountsText != ''">
				AND discounts_text = #{discountsText}
			</if>
			<if test="discountsNumber != null and discountsNumber != ''">
				AND discounts_number = #{discountsNumber}
			</if>
			<if test="discountsDate != null and discountsDate != ''">
				AND discounts_date = #{discountsDate}
			</if>
			<if test="discountsValid != null and discountsValid != ''">
				AND discounts_valid = #{discountsValid}
			</if>
			<if test="discountsAddr != null and discountsAddr != ''">
				AND discounts_addr = #{discountsAddr}
			</if>
		</where>
	</select>
	<select id="queryCouponById" resultMap="couponEntity">
		select <include refid="coupon_column"/> from discounts_tab where discounts_id = #{discountsId}
	</select>
	<select id="queryCouponByUserId" parameterType="java.lang.Integer" resultMap="useCouponEntity">
		select <include refid="discounts_use_column"/> from discounts_use_tab
		where usesr_id = #{userId}
	</select>
	<delete id="deleteCoupon" parameterType="java.lang.Integer" >
		delete discounts_tab where discounts_id = #{discountsId}
	</delete>
	<update id="delCoupon" parameterType="com.entity.Coupon">
		update discounts_tab set discounts_valid = #{discountsValid} where discounts_id = #{discountsId}
	</update>
	<insert id="addCoupon" parameterType="com.entity.Coupon">
		insert into discounts_tab
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="discountsText != null and discountsText !=''">
				discounts_text,
			</if>
			<if test="discountsNumber != null and discountsNumber !=''">
				discounts_number,
			</if>
			<if test="discountsDate != null and discountsDate !=''">
				discounts_date,
			</if>
			<if test="discountsValid != null and discountsValid !=''">
				discounts_valid,
			</if>
			<if test="discountsAddr != null and discountsAddr !=''">
				discounts_addr,
			</if>
		</trim>
		 <trim prefix="values(" suffix=")" suffixOverrides=",">
		 	<if test="discountsText != null and discountsText !=''">
				#{discountsText},
			</if>
			<if test="discountsNumber != null and discountsNumber !=''">
				#{discountsNumber},
			</if>
			<if test="discountsDate != null and discountsDate !=''">
				#{discountsDate},
			</if>
			<if test="discountsValid != null and discountsValid !=''">
				#{discountsValid},
			</if>
			<if test="discountsAddr != null and discountsAddr !=''">
				#{discountsAddr},
			</if>
		 </trim>
	</insert>
	<insert id="addDiscountsUse" parameterType="com.entity.Coupon">
		insert into discounts_use_tab
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="userId != null and userId !=''">
				user_id,
			</if>
			<if test="discountsId != null and discountsId !=''">
				discounts_id,
			</if>
			<if test="videoId != null and videoId !=''">
				video_id,
			</if>
			<if test="comboId != null and comboId !=''">
				combo_id,
			</if>
			<if test="discountsDate != null and discountsDate !=''">
				discounts_date,
			</if>
		</trim>
		 <trim prefix="values(" suffix=")" suffixOverrides=",">
		 	<if test="userId != null and userId !=''">
				#{userId},
			</if>
			<if test="discountsId != null and discountsId !=''">
				#{discountsId},
			</if>
			<if test="videoId != null and videoId !=''">
				#{videoId},
			</if>
			<if test="comboId != null and comboId !=''">
				#{comboId},
			</if>
			<if test="discountsDate != null and discountsDate !=''">
				#{discountsDate},
			</if>
		 </trim>
	</insert>
	<update id="updateCoupon" parameterType="com.entity.Coupon">
		update discounts_tab 
		<set>
		 	<if test="discountsText != null and discountsText !=''">
				discounts_text = #{discountsText},
			</if>
			<if test="discountsNumber != null and discountsNumber !=''">
				discounts_number = #{discountsNumber},
			</if>
			<if test="discountsDate != null and discountsDate !=''">
				discounts_date = #{discountsDate},
			</if>
			<if test="discountsValid != null and discountsValid !=''">
				discounts_valid = #{discountsValid},
			</if>
			<if test="discountsAddr != null and discountsAddr !=''">
				discounts_addr = #{discountsAddr},
			</if>
		</set>
		where discounts_id = #{discounts_Id}
	</update>
	<!-- <update id="updateDiscountsUse" parameterType="com.entity.UseCoupon">
		update discounts_use_tab 
		<set>
		 	<if test="userId != null and userId !=''">
				user_id = #{userId},
			</if>
			<if test="discountsId != null and discountsId !=''">
				discounts_id = #{discountsId},
			</if>
			<if test="videoId != null and videoId !=''">
				video_id = #{videoId},
			</if>
			<if test="comboId != null and comboId !=''">
				combo_id = #{comboId},
			</if>
			<if test="discountsDate != null and discountsDate !=''">
				discounts_date = #{discountsDate},
			</if>
		</set>
	</update> -->
	<!-- 根据年级查询课程分类信息 -->
	<select id="queryvideoFormClass" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select video_form_id,video_form_name from video_form_tab where video_form_class =#{video_form_class}
	</select>
	<!-- 根据课程分类ID查询所属课程信息 -->
	<select id="queryCoursesTabAll" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select courses_id,courses_name from courses_tab where video_form_id =#{video_form_id}
	</select>
	<!-- 添加优惠卷信息 -->
	<insert id="addDiscountsTab" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="discounts_id">
		insert into discounts_tab(discounts_text, discounts_money, discounts_date,courses_id) VALUES 
		(#{discounts_text},#{discounts_money},str_to_date(#{discounts_date}, '%Y-%m-%d %H:%i:%s'),#{courses_id})
	</insert>
	<!-- 添加优惠码信息 -->
	<insert id="addDiscountsNumberTab" parameterType="java.util.ArrayList">
		insert into discounts_number_tab(discounts_id,discounts_code) VALUES
		 <foreach collection ="list" item="reddemCode" index= "index" separator =",">
               (#{reddemCode.discounts_id},#{reddemCode.discounts_code})
         </foreach >
	</insert>
	<!-- 查询优惠卷信息 -->
	<select id="queryDiscountsTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select discounts_id,discounts_text,discounts_money,date_format(discounts_date,'%Y-%m-%d')discounts_date,dis.courses_id,cou.courses_name from discounts_tab dis
		left join courses_tab cou on dis.courses_id=cou.courses_id
		order by discounts_id desc
		limit #{startNum},#{endIndex}
	</select>
	<!-- 查询优惠卷信息总数 -->
	<select id="queryDiscountsTabCount" parameterType="java.util.HashMap" resultType="int">
		select count(1) from discounts_tab dis
		left join courses_tab cou on dis.courses_id=cou.courses_id
	</select>
	<!-- 修改优惠卷信息 -->
	<update id="updateDiscountsTab" parameterType="java.util.HashMap">
		update discounts_tab set discounts_text =#{discounts_text} ,discounts_money=#{discounts_money} ,discounts_date=str_to_date(#{discounts_date}, '%Y-%m-%d %H:%i:%s')
		where discounts_id = ${discounts_id}
	</update>
	<!-- 根据优惠卷ID查询优惠码信息 -->
	<select id="queryDiscountsNumberTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select discounts_number_id,discounts_code,user_id,discounts_date,discounts_id from  discounts_number_tab
		where discounts_id = #{discounts_id} order by discounts_number_id desc
	</select>
</mapper>