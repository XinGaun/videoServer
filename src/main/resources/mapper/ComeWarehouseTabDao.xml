<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.ComeWarehouseTabDao">
	<!-- 添加出库单信息 -->
	<insert id="addComeWarehouseTab" parameterType="com.entity.ComeWarehouseTab">
		INSERT INTO come_warehouse_tab(come_ware_cause, purc_id,staff_id,come_ware_date) VALUES (#{come_ware_cause},#{purc_id},#{staff_id},to_timestamp(#{come_ware_date},'yyyy-mm-dd hh24:mi:ss'))
	</insert>
	<!-- 查询出库单信息 -->
	<select id="queryComeWarehouseTab" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT come_ware_id,come_ware_cause,purc_id,staff_id,to_char(come_ware_date,'yyyy-mm-dd hh24:mi:ss')come_ware_date FROM come_warehouse_tab WHERE 1=1 
		<if test="come_ware_id!=null">
			and come_ware_id = #{come_ware_id}
		</if>
		<if test="purc_id!=null">
			and purc_id = #{purc_id}
		</if>
		<if test="staff_id!=null">
			and staff_id = #{staff_id}
		</if> 
		LIMIT #{page} OFFSET #{nums}
	</select>
	<!-- 查询出库单总数信息 -->
	<select id="queryComeWarehouseTabCount" resultType="int" parameterType="java.util.HashMap">
		SELECT COUNT(come_ware_id) FROM come_warehouse_tab WHERE 1=1 
		<if test="come_ware_id!=null">
			and come_ware_id = #{come_ware_id}
		</if>
		<if test="purc_id!=null">
			and purc_id = #{purc_id}
		</if>
		<if test="staff_id!=null">
			and staff_id = #{staff_id}
		</if> 
	</select>
	<!-- 更新出库单信息 -->
	<update id="updateComeWarehouseTab" parameterType="com.entity.ComeWarehouseTab">
		UPDATE come_warehouse_tab 
		<trim prefix="set" suffixOverrides=",">
			<if test="come_ware_cause!=null">
				come_ware_cause=#{come_ware_cause},
			</if>
			<if test="purc_id!=null">
				purc_id=#{purc_id},
			</if>
			<if test="staff_id!=null">
				staff_id=#{staff_id},
			</if>
			<if test="come_ware_date!=null">
				come_ware_date=to_timestamp(#{come_ware_date},'yyyy-mm-dd hh24:mi:ss'),
			</if>
		</trim> 
		WHERE come_ware_id =#{come_ware_id}
	</update>
	<!-- 删除出库单信息 -->
	<delete id="deleteComeWarehouseTab" parameterType="int">
		DELETE FROM come_warehouse_tab WHERE come_ware_id =#{come_ware_id}
	</delete>
	<!-- map添加出库单信息 -->
	<insert id="addComeWarehouseTabMap" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="come_ware_id">
		INSERT INTO come_warehouse_tab(come_ware_cause,staff_id,come_ware_date
		<if test="purc_id!=null">
			,purc_id
		</if>
		) VALUES (#{come_ware_cause},#{staff_id},now()
		<if test="purc_id!=null">
			,#{purc_id}
		</if>
		)
	</insert>
	<!-- 添加库存变更记录 -->
	<insert id="addinventoryAlterTab" parameterType="java.util.HashMap">
		INSERT INTO inventory_alter_tab(warehouse_id,comm_id,cargo_id,inve_alter_code,inve_alter_type,inve_alter_cause,inve_alter_date,come_ware_id,staff_id
		<if test="source_ware_id!=null">
			,source_ware_id
		</if>
		<if test="bourn_ware_id!=null">
			,bourn_ware_id
		</if>
		<if test="purc_id!=null">
			,purc_id
		</if>
		<if test="orde_id!=null">
			,orde_id
		</if>
		<if test="chan_id!=null">
			,chan_id
		</if>
		<if test="deli_id!=null">
			,deli_id
		</if>
		<if test="inve_alter_remark!=null">
			,inve_alter_remark
		</if>
		<if test="shop_id!=null">
			,shop_id
		</if>
		) 
    	VALUES (#{warehouse_id},#{comm_id},#{cargo_id},#{inve_alter_code},#{inve_alter_type},#{inve_alter_cause},to_timestamp(#{inve_alter_date},'yyyy-mm-dd hh24:mi:ss'),#{come_ware_id},#{staff_id}
    	<if test="source_ware_id!=null">
			,#{source_ware_id}
		</if>
		<if test="bourn_ware_id!=null">
			,#{bourn_ware_id}
		</if>
		<if test="purc_id!=null">
			,#{purc_id}
		</if>
		<if test="orde_id!=null">
			,#{orde_id}
		</if>
		<if test="chan_id!=null">
			,#{chan_id}
		</if>
		<if test="deli_id!=null">
			,#{deli_id}
		</if>
		<if test="inve_alter_remark!=null">
			,#{inve_alter_remark}
		</if>
		<if test="shop_id!=null">
			,#{shop_id}
		</if>
    	)
	</insert>
	<!-- 更新对应的库存明细表 -->
	<insert id="addinventoryDetailtab" parameterType="java.util.HashMap">
		INSERT INTO inventory_detail_tab(ware_id, comm_id, cargo_id, inve_code, inve_status, staf_id, inve_come_sign, inve_come_date, come_ware_id) VALUES
  		(#{warehouse_id},#{comm_id},#{cargo_id},#{inve_alter_code},'在途',#{staff_id},'C',to_timestamp(#{come_ware_date},'yyyy-mm-dd hh24:mi:ss'),#{come_ware_id})
	</insert>
	<!-- 查询原仓库库存量信息 -->
	<select id="querystockMap" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT stoc_id,ware_id,comm_id,stoc_count,lock_count,scrap_count,ship_count,sample_count FROM stock_tab WHERE ware_id =#{warehouse_id} and comm_id = #{comm_id};
	</select>
	<!-- 更新仓库的库存量信息 -->
	<update id="updatestockMap" parameterType="java.util.HashMap">
		UPDATE stock_tab SET stoc_count = #{stoc_count}
		<if test="ship_count!=null">
			,ship_count=#{ship_count}
		</if>
		<if test="scrap_count!=null">
			,scrap_count=#{scrap_count}
		</if>
		<if test="sample_count!=null">
			,sample_count=#{sample_count}
		</if>
		 WHERE stoc_id = #{stoc_id}
	</update>
	<!-- 添加目的仓库增加货物在途记录 -->
	<insert id="addmdinventoryDetailtab" parameterType="java.util.HashMap">
		update inventory_detail_tab set ware_id =#{bourn_ware_id},comm_id=#{comm_id},
		inve_code=#{inve_alter_code},inve_status='在途' where cargo_id=#{cargo_id}
		<!-- INSERT INTO inventory_detail_tab(ware_id, comm_id, cargo_id, inve_code, inve_status) VALUES
  		(#{bourn_ware_id},#{comm_id},#{cargo_id},#{inve_alter_code},'在途') -->
	</insert>
	<!-- 查询目的仓库库存量信息 -->
	<select id="queryMdstockMap" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT stoc_id,ware_id,comm_id,stoc_count,lock_count,scrap_count,ship_count FROM stock_tab WHERE ware_id =#{bourn_ware_id} and comm_id = #{comm_id};
	</select>
	<!--更新库存量信息  -->
	<update id="updateMdstockMap" parameterType="java.util.HashMap">
		UPDATE stock_tab SET stoc_count = #{stoc_count},ship_count=#{ship_count} WHERE stoc_id = #{stoc_id}
	</update>
	<!-- 查询订单信息 -->
	<select id="queryOrderTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT come_ware_id FROM inventory_alter_tab WHERE deli_id = #{deli_id}
	</select>
	<!-- 添加库存量信息 -->
	<insert id="addStockTab" parameterType="java.util.HashMap">
		INSERT INTO stock_tab(ware_id, comm_id,stoc_count,lock_count,scrap_count,ship_count)
		VALUES (#{bourn_ware_id},#{comm_id},0,0,0,0)
	</insert>
	<!-- 查询货物ID -->
	<select id="queryInventoryAlter" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT cargo_id,inve_code FROM inventory_detail_tab WHERE comm_id = #{comm_id} AND ware_id = #{warehouse_id} 
		<if test="shop_id!=null">
			and shop_id =#{shop_id}
		</if>
		and inve_come_sign IS NULL LIMIT #{num};
	</select>
	<!-- 更新库存明细标记 -->
	<update id="updateDnventorydetailTab" parameterType="java.util.HashMap">
		UPDATE inventory_detail_tab SET inve_come_sign = 'C',come_ware_id = #{come_ware_id}
		<if test="inve_alter_cause!=null">
			,inve_cause= #{inve_alter_cause}
		</if>
		<if test="staff_id!=null">
			,staf_id= #{staff_id}
		</if>
		<if test="inve_join_date!=null">
			,inve_join_date= #{inve_alter_date}
		</if>
		<if test="inve_alter_type!=null">
			,inve_status= #{inve_alter_type}
		</if>
		 WHERE cargo_id =#{cargo_id}
	</update>
	<!-- 根据订单ID查询订单信息 -->
	<select id="queryOrderID" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT * FROM order_tab WHERE orde_id =#{orde_id}
	</select>
	<!-- 更新配送单信息 -->
	<update id="updateDeliver" parameterType="java.util.HashMap">
		UPDATE deliver_tab SET deli_status = #{status} WHERE deli_id = #{deli_id}
	</update>
	<!-- 查询商品销售记录 -->
	<select id="queryRecord" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT * FROM sales_record_tab WHERE orde_id=#{orde_id} and chan_id is null
	</select>
	<!-- 查询退换货信息 -->
	<select id="queryChangeTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT * FROM change_tab WHERE chan_id =#{chan_id}
	</select>
	<!-- 更新退换货状态 -->
	<update id="updateChangeTab" parameterType="java.util.HashMap">
		update change_tab set chan_status = #{chan_status},return_date = now() where chan_id = #{chan_id}
	</update>
	<!-- 查询符合销售的货物ID -->
	<select id="queryInventoryDetailTabCargoId" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT cargo_id,inve_code FROM inventory_detail_tab WHERE comm_id = #{comm_id} AND ware_id = #{warehouse_id} AND  inve_status = '在库' LIMIT 1
	</select>
	<!-- 添加货物ID到商品销售记录中 -->
	<update id="updateSalesRecordTab" parameterType="java.util.HashMap">
		UPDATE sales_record_tab SET cargo_id = #{cargo_id} 
		<if test="chan_id!=null">
			,chan_id = #{chan_id}
		</if>
		where sale_id =#{sale_id}
	</update>
	<!-- 根据商品销售记录ID 查询商品销售记录信息 -->
	<select id="querySaleRecordTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select sale_id,orde_id,comm_id,sale_price,real_price,cargo_id,discounts_id,sale_change from sales_record_tab
		where sale_id = #{sale_id}
	</select>
	<!-- 退换货添加新的商品销售记录 -->
	<insert id="addSaleRecordTab" parameterType="java.util.HashMap">
		insert into sales_record_tab(comm_id, sale_price, real_price
		<if test="discounts_id!=null">
			,discounts_id
		</if>
		<if test="cargo_id!=null">
			,cargo_id
		</if>
		<if test="orde_id!=null">
			,orde_id
		</if>
		) VALUES
		(#{comm_id},#{sale_price},#{real_price}
		<if test="discounts_id!=null">
			,#{discounts_id}
		</if>
		<if test="cargo_id!=null">
			,#{cargo_id}
		</if>
		<if test="orde_id!=null">
			,#{orde_id}
		</if>
		)
	</insert>
	<!-- 退换货根据货物ID修改库存明细 -->
	<update id="updateInventoryDetailTab" parameterType="java.util.HashMap">
		update inventory_detail_tab set inve_status = #{inve_status},inve_cause = #{inve_cause},staf_id = #{staf_id}
		,inve_join_date = now(),inve_come_sign = null,inve_come_date = null,come_ware_id=null,ware_id=#{ware_id}
		where cargo_id = #{cargo_id}
	</update>
	<!-- 添加库存变更记录 -->
	<insert id="addInventoryAlterTabChange" parameterType="java.util.HashMap">
		insert into inventory_alter_tab(warehouse_id, comm_id, cargo_id, inve_alter_type, inve_alter_cause, inve_alter_date, orde_id, chan_id, staff_id
		<if test="deli_id!=null">
			,deli_id
		</if>
		<if test="inve_alter_code!=null">
			,inve_alter_code
		</if>
		) values
		(#{ware_id},#{comm_id},#{cargo_id},#{inve_cause},#{inve_alter_cause},now(),#{orde_id},#{chan_id},#{staf_id}
		<if test="deli_id!=null">
			,#{deli_id}
		</if>
		<if test="inve_alter_code!=null">
			,#{inve_alter_code}
		</if>
		)
	</insert>
	<!-- 配送单ID查询配送单信息 -->
	<select id="queryDeliverTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select * from deliver_tab where deli_id = #{deli_id}
	</select>
	<!-- 更新退换货单状态为完成 -->
	<update id="updateChangeTabStatus" parameterType="java.util.HashMap">
		update change_tab set cargo_status = #{cargo_status} where chan_id = #{chan_id}
	</update>
	<!--  -->
	<select id="queryChanIdSaleRecordTab" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select * from sales_record_tab where chan_id = #{chan_id};
	</select>
	<!-- 更新订单状态 -->
	<update id="updateOrder" parameterType="java.util.HashMap">
		update order_tab set orde_status = #{status} where orde_id = #{orde_id}
	</update>
</mapper>