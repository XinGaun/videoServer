<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.DeliverTabDao">
	<!-- 添加配送单信息 -->
	<insert id="addDeliverTab" parameterType="com.entity.DeliverTab">
		INSERT INTO deliver_tab(orde_id,
		jdde_id,deli_addr,deli_phone,deli_name,deli_status
		<if test="staf_id!=null and staf_id!=0">
			,staf_id
		</if>
		<if test="chan_id!=null">
			,chan_id
		</if>
		<if test="deli_make_date!=null">
			,deli_make_date
		</if>
		<if test="deli_delivery_date!=null">
			,deli_delivery_date
		</if>
		<if test="deli_come_date!=null">
			,deli_come_date
		</if>
		<if test="deli_visit_date!=null">
			,deli_visit_date
		</if>
		<if test="deli_sign_date!=null">
			,deli_sign_date
		</if>
		<if test="deli_sign_name!=null">
			,deli_sign_name
		</if>
		<if test="deli_remark!=null">
			,deli_remark
		</if>
		)
		VALUES
		(#{orde_id},#{jdde_id},#{deli_addr},#{deli_phone},#{deli_name},#{deli_status}
		<if test="staf_id!=null and staf_id!=0">
			,#{staf_id}
		</if>
		<if test="chan_id!=null">
			,#{chan_id}
		</if>
		<if test="deli_make_date!=null">
			,to_timestamp(#{deli_make_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="deli_delivery_date!=null">
			, to_timestamp(#{deli_delivery_date},'yyyy-mm-dd
			hh24:mi:ss')
		</if>
		<if test="deli_come_date!=null">
			, to_timestamp(#{deli_come_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="deli_visit_date!=null">
			, to_timestamp(#{deli_visit_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="deli_sign_date!=null">
			, to_timestamp(#{deli_sign_date},'yyyy-mm-dd hh24:mi:ss')
		</if>
		<if test="deli_sign_name!=null">
			,#{deli_sign_name}
		</if>
		<if test="deli_remark!=null">
			,#{deli_remark}
		</if>
		)
	</insert>
	<!-- 订单表 -->
	<resultMap type="java.util.HashMap" id="order_tab">
		<id property="orde_id" column="ord_id" />
		<result property="orde_total_val" column="orde_total_val" />
		<result property="orde_status" column="orde_status" />
		<result property="buye_id" column="buye_id" />
		<result property="orde_addr" column="orde_addr" />
		<result property="orde_phone" column="orde_phone" />
		<result property="pay_status" column="pay_status" />
		<result property="pay_type" column="pay_type" />
		<result property="fina_tab" column="fina_tab" />
		<result property="orde_date" column="orde_date" />
		<result property="pay_date" column="pay_date" />
		<result property="orde_remark" column="orde_remark" />
		<result property="delivery_type" column="delivery_type" />
		<result property="deli_id" column="ord_deli_id" />
		<result property="staf_deli_id" column="ord_staf_deli_id" />
		<result property="inst_id" column="ord_inst_id" />
		<result property="staf_insf_id" column="ord_staf_insf_id" />
		<result property="ware_id" column="ord_ware_id" />
		<result property="sell_type" column="sell_type" />
		<result property="staf_sell_id" column="ord_staf_sell_id" />
		<result property="orde_invoice" column="orde_invoice" />
	</resultMap>
	<!-- 换货单表 -->
	<resultMap type="java.util.HashMap" id="change_tab">
		<id property="chan_id" column="cha_chan_id" />
		<result property="orde_id" column="cha_orde_id" />
		<result property="sale_id" column="cha_sale_id" />
		<result property="chan_num" column="chan_num" />
		<result property="chan_status" column="chan_status" />
		<result property="staf_acce_id" column="staf_acce_id" />
		<result property="chan_sign" column="chan_sign" />
		<result property="apply_date" column="apply_date" />
		<result property="cargo_status" column="cargo_status" />
		<result property="refund_date" column="refund_date" />
		<result property="chan_date" column="chan_date" />
		<result property="staf_refu_id" column="staf_refu_id" />
		<result property="refund_audit_date" column="refund_audit_date" />
		<result property="refund_type" column="refund_type" />
		<result property="refund_number" column="refund_number" />
		<result property="refund_date" column="refund_date" />
		<result property="chan_delivery_type" column="chan_delivery_type" />
		<result property="deli_id" column="cha_deli_id" />
		<result property="inst_id" column="cha_inst_id" />
		<result property="chan_cause" column="chan_cause" />
		<result property="chan_remark" column="chan_remark" />
		<result property="chan_img" column="chan_img" />
	</resultMap>
	<!-- 配送单位表 -->
	<resultMap type="java.util.HashMap" id="jdde_tab">
		<id property="jdde_id" column="jdd_jdde_id" />
		<result property="jdde_name" column="jdde_name" />
		<result property="jdde_scope" column="jdde_scope" />
		<result property="branch_id" column="jdde_branch_id" />
		<result property="jdde_stop_status" column="jdde_stop_status" />
		<result property="jdde_dete_status" column="jdde_dete_status" />
	</resultMap>
	<!-- 员工表 -->
	<resultMap type="java.util.HashMap" id="staff_tab">
		<id property="staf_id" column="sta_staf_id" />
		<result property="staf_usr_name" column="staf_usr_name" />
		<result property="staf_name" column="staf_name" />
		<result property="staf_sales" column="staf_sales" />
		<result property="shop_id" column="sta_shop_id" />
		<result property="jdde_id" column="sta_jdde_id" />
		<result property="inst_unit_id" column="sta_inst_unit_id" />
		<result property="ware_id" column="sta_ware_id" />
		<result property="staf_role" column="sta_staf_role" jdbcType="ARRAY"/>
		<result property="staf_date" column="staf_date" />
		<result property="staf_stop_status" column="staf_stop_status" />
		<result property="staf_dete_status" column="staf_dete_status" />
		<result property="staf_job" column="staf_job" />
		<result property="branch_id" column="branch_id" />
	</resultMap>
	<!-- 配送单信息 -->
	<resultMap type="java.util.HashMap" id="deliver_tab">
		<id property="deli_id" column="deli_id" />
		<result property="orde_id" column="orde_id" />
		<result property="chan_id" column="chan_id" />
		<result property="jdde_id" column="jdde_id" />
		<result property="deli_addr" column="deli_addr" />
		<result property="deli_phone" column="deli_phone" />
		<result property="deli_name" column="deli_name" />
		<result property="deli_make_date" column="deli_make_date" />
		<result property="deli_delivery_date" column="deli_delivery_date" />
		<result property="staf_id" column="staf_id" />
		<result property="deli_come_date" column="deli_come_date" />
		<result property="deli_visit_date" column="deli_visit_date" />
		<result property="deli_sign_date" column="deli_sign_date" />
		<result property="deli_sign_name" column="deli_sign_name" />
		<result property="deli_status" column="deli_status" />
		<result property="deli_remark" column="deli_remark" />
		<result property="come_ware_date" column="come_ware_date" />
		<collection property="order_tab" resultMap="order_tab"></collection>
		<collection property="change_tab" resultMap="change_tab"></collection>
		<collection property="jdde_tab" resultMap="jdde_tab"></collection>
		<collection property="staff_tab" resultMap="staff_tab"></collection>
	</resultMap>
	<!-- 查询配送单信息 -->
	<select id="queryDeliverTab" resultMap="deliver_tab"
		parameterType="java.util.HashMap">
		SELECT
		del.deli_id,del.orde_id,del.chan_id,del.jdde_id,deli_addr,deli_phone,deli_name,to_char(deli_make_date,'yyyy-mm-dd hh24:mi:ss')deli_make_date,to_char(deli_delivery_date,'yyyy-mm-dd hh24:mi:ss')deli_delivery_date,del.staf_id,to_char(deli_come_date,'yyyy-mm-dd hh24:mi:ss')deli_come_date,to_char(deli_visit_date,'yyyy-mm-dd hh24:mi:ss')deli_visit_date,to_char(deli_sign_date,'yyyy-mm-dd hh24:mi:ss')deli_sign_date,deli_sign_name,deli_status,deli_remark,
		ord.orde_id
		ord_id,ord.orde_total_val,orde_status,buye_id,orde_addr,orde_phone,pay_status,pay_type,fina_tab,to_char(orde_date,'yyyy-mm-dd hh24:mi:ss')orde_date,to_char(pay_date,'yyyy-mm-dd hh24:mi:ss')pay_date,orde_remark,delivery_type,ord.deli_id
		ord_deli_id,ord.staf_deli_id ord_staf_deli_id,ord.inst_id
		ord_inst_id,ord.staf_insf_id ord_staf_insf_id,ord.ware_id
		ord_ware_id,ord.sell_type,ord.staf_sell_id
		ord_staf_sell_id,ord.orde_invoice,
		cha.chan_id cha_chan_id,cha.orde_id cha_orde_id,cha.comm_id
		cha_sale_id,cha.chan_num,cha.chan_status,cha.staf_acce_id,cha.chan_sign,
		to_char(cha.apply_date,'yyyy-mm-dd hh24:mi:ss')apply_date,
		to_char(cha.refund_date,'yyyy-mm-dd hh24:mi:ss')refund_date,to_char(cha.chan_date,'yyyy-mm-dd hh24:mi:ss')chan_date,
		cha.staf_refu_id,to_char(cha.refund_audit_date,'yyyy-mm-dd hh24:mi:ss')refund_audit_date,cha.refund_type,cha.refund_number,
		to_char(cha.refund_date,'yyyy-mm-dd hh24:mi:ss')refund_date,cha.chan_delivery_type,cha.deli_id
		cha_deli_id,cha.inst_id cha_inst_id,
		cha.chan_cause,cha.chan_remark,cha.chan_img,
		jdd.jdde_id jdd_jdde_id,jdd.branch_id jdde_branch_id,
		jdd.jdde_name,jdd.jdde_scope,jdd.jdde_stop_status,jdd.jdde_dete_status,
		sta.staf_id
		sta_staf_id,sta.staf_usr_name,sta.staf_name,sta.staf_sales,sta.shop_id
		sta_shop_id,sta.jdde_id sta_jdde_id,
		sta.inst_unit_id sta_inst_unit_id,sta.ware_id
		sta_ware_id,sta.staf_role sta_staf_role,
		to_char(sta.staf_date,'yyyy-mm-dd hh24:mi:ss')staf_date,sta.staf_stop_status,sta.staf_dete_status
		FROM deliver_tab del
		LEFT JOIN order_tab ord ON del.orde_id = ord.orde_id
		LEFT JOIN change_tab cha ON cha.chan_id = del.chan_id
		LEFT JOIN jdde_tab jdd ON del.jdde_id = jdd.jdde_id
		LEFT JOIN staff_tab sta ON del.staf_id = sta.staf_id
		WHERE 1=1 AND del.deli_status != '未激活'
		<if test="deli_id!=null">
			and del.deli_id = #{deli_id}
		</if>
		<if test="orde_id!=null">
			and del.orde_id = #{orde_id}
		</if>
		<if test="chan_id!=null">
			and del.chan_id = #{chan_id}
		</if>
		<if test="jdde_id!=null">
			and del.jdde_id = #{jdde_id}
		</if>
		<if test="deli_addr!=null">
			and del.deli_addr = #{deli_addr}
		</if>
		<if test="deli_phone!=null">
			and del.deli_phone = #{deli_phone}
		</if>
		<if test="deli_name!=null">
			and del.deli_name = #{deli_name}
		</if>
		<if test="staf_id!=null">
			and del.staf_id = #{staf_id}
		</if>
		<if test="deli_sign_name!=null">
			and del.deli_sign_name = #{deli_sign_name}
		</if>
		<if test="deli_status!=null">
			and del.deli_status = #{deli_status}
		</if>
		<if test="chan!=null">
			and del.chan_id is null
		</if>
		<if test="make==0">
			ORDER BY deli_make_date ASC
		</if>
		<if test="make==1">
			ORDER BY deli_make_date DESC
		</if>
		
		LIMIT #{page} OFFSET #{nums}
	</select>
	<!-- 查询配送单总数信息 -->
	<select id="queryDeliverTabCount" resultType="int"
		parameterType="java.util.HashMap">
		SELECT COUNT(del.deli_id) from deliver_tab del
		LEFT JOIN order_tab ord ON del.orde_id = ord.orde_id
		LEFT JOIN change_tab cha ON cha.chan_id = del.chan_id
		LEFT JOIN jdde_tab jdd ON del.jdde_id = jdd.jdde_id
		LEFT JOIN staff_tab sta ON del.staf_id = sta.staf_id
		WHERE 1=1 AND del.deli_status != '未激活'
		<if test="deli_id!=null">
			and del.deli_id = #{deli_id}
		</if>
		<if test="orde_id!=null">
			and del.orde_id = #{orde_id}
		</if>
		<if test="chan_id!=null">
			and del.chan_id = #{chan_id}
		</if>
		<if test="jdde_id!=null">
			and del.jdde_id = #{jdde_id}
		</if>
		<if test="deli_addr!=null">
			and del.deli_addr = #{deli_addr}
		</if>
		<if test="deli_phone!=null">
			and del.deli_phone = #{deli_phone}
		</if>
		<if test="deli_name!=null">
			and del.deli_name = #{deli_name}
		</if>
		<if test="staf_id!=null">
			and del.staf_id = #{staf_id}
		</if>
		<if test="deli_sign_name!=null">
			and del.deli_sign_name = #{deli_sign_name}
		</if>
		<if test="deli_status!=null">
			and del.deli_status = #{deli_status}
		</if>
		<if test="chan!=null">
			and del.chan_id is null
		</if>
	</select>
	<!-- 更新配送单信息 -->
	<update id="updateDeliverTab" parameterType="com.entity.DeliverTab">
		UPDATE deliver_tab
		<trim prefix="set" suffixOverrides=",">
			<if test="orde_id!=null">
				orde_id=#{orde_id},
			</if>
			<if test="chan_id!=null">
				chan_id=#{chan_id},
			</if>
			<if test="jdde_id!=null">
				jdde_id=#{jdde_id},
			</if>
			<if test="deli_addr!=null">
				deli_addr=#{deli_addr},
			</if>
			<if test="deli_phone!=null">
				deli_phone=#{deli_phone},
			</if>
			<if test="deli_name!=null">
				deli_name=#{deli_name},
			</if>
			<if test="deli_make_date!=null">
				deli_make_date=to_timestamp(#{deli_make_date},'yyyy-mm-dd
				hh24:mi:ss'),
			</if>
			<if test="staf_id!=null">
				staf_id=#{staf_id},
			</if>
			<if test="deli_come_date!=null">
				deli_come_date=to_timestamp(#{deli_come_date},'yyyy-mm-dd
				hh24:mi:ss'),
			</if>
			<if test="deli_visit_date!=null">
				deli_visit_date=to_timestamp(#{deli_visit_date},'yyyy-mm-dd
				hh24:mi:ss'),
			</if>
			<if test="deli_sign_name!=null">
				deli_sign_name=#{deli_sign_name},
			</if>
			<if test="deli_sign_date!=null">
				deli_sign_date=to_timestamp(#{deli_sign_date},'yyyy-mm-dd
				hh24:mi:ss'),
			</if>
			<if test="deli_status!=null">
				deli_status=#{deli_status},
			</if>
			<if test="deli_remark!=null">
				deli_remark=#{deli_remark},
			</if>
		</trim>
		WHERE deli_id =#{deli_id}
	</update>
	<!-- 删除配送单信息 -->
	<delete id="deleteDeliverTab" parameterType="int">
		DELETE FROM
		deliver_tab WHERE deli_id =#{deli_id}
	</delete>
	<!-- 更新订单信息 -->
	<update id="updateOrder" parameterType="java.util.HashMap">
		update order_tab set orde_status = #{status} where deli_id =${deli_id}
	</update>
	<!-- 更新配送单接单信息 -->
	<update id="updateSignDeliverTabAll" parameterType="java.util.HashMap">
		UPDATE deliver_tab set deli_status=#{deli_status} where deli_id =#{deli_id}
	</update>
</mapper>