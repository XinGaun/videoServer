<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style type="text/css">
#jd:after {
	content: '%';
}
</style>
<link rel="stylesheet"
	href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
<script
	src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/socket.io.js"></script>
</head>

<body>
	<h3>File upload demo</h3>
	<div class="modal fade" id="myModal" tabindex="-1"
		role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">课程视频修改</h4>
				</div>
				<form action="/videoServer/UploadServlet/upload" method="post"
					enctype="multipart/form-data" id="dataForm">
					<input type="text" name="videoName" id="videoName"> <br>
					<input type="file" name="video" id="video" accept="video/*"><br>
					<input type="file" name="image" id="image" accept="image/*">
					<br> <input type="submit" value="submit" id="submit">
				</form>
				<div id="jd"></div>
			</div>
		</div>
	</div>

	<div>
	       <button type="button" class="btn btn-danger"
			data-toggle="modal" data-target="#myModal">添加视频</button>
	</div>
</body>
<script src="assets/js/jquery-1.10.2.js"></script>
<script type="text/javascript">
var progress = document.getElementById("jd");
var socket ;
	function connect(){
		//创建socket连接	
		 socket = io.connect('http://127.0.0.1:8099');
		//连接成功后会监听到
		socket.on('connect', function() {
			output('<span>连接成功</span>');
		});

		socket.on('connecting', function() {
			output('<span>正在连接...</span>');
		});

		socket.on('disconnect', function() {
			output('<span>断开连接! </span>');
		});

		socket.on('reconnecting', function() {
			output('<span>正在重连...</span>');
		});

		socket.on('reconnect', function() {
			output('<span>成功重连！</span>');
		});

		socket.on('connect_failed', function() {
			output('<span>连接失败！</span>');
		});
	};
		//想要断开连接调用此方法
		function sendDisconnect() {
			socket.disconnect();
		};
		function output(message) {
			progress.innerText = message;
		}
		
		function soucketStart(){
	    	 //启动socket
	    		$.ajax({
	    			url : 'http://localhost:8080/videoServer/socketServer/start',
	    			type : 'post',				
	    			success : function() {	  				
	    			},
	    			error : function() {
	    				//alert("soucketStart error");
	    			}
	    		});	  
		}
		//stop
		function soucketStop(){
			 		$.ajax({
			 			url : 'http://localhost:8080/videoServer/socketServer/stop',
			 			type : 'post',				
			 			success : function() {			 				
			 			},
			 			error : function() {
			 				//alert(" soucketStop error");
			 			}
			 		});	 
		}
		//加载模态框    
	    $('#myModal').on('show.bs.modal', function (event) {  	    	
	       progress.innerText= 0;	 	  
	 	   socket.connect();
	 	   soucketStart();
	    }); 
		$("#submit").click(function() {
			//表单参数
			var formData = new FormData(); //重点：要用这种方法接收表单的参数  
			var video = $('#video').prop("files")[0];
			var image = $('#image').prop("files")[0];
			var videoName = $('#videoName').val();
			formData.append("videoName", videoName);
			formData.append("video", video);
			formData.append("image", image);
			//阻止默认事件
			event.preventDefault();
			//上传文件
			$.ajax({
				url : 'http://localhost:8080/videoServer/UploadServlet/upload',
				type : 'post',
				data : formData,
				cache : false,
				processData : false,
				contentType : false,
				success : function() {
					progress.innerText = 100;
					alert("上传成功");			   
					soucketStop();
					sendDisconnect();
				    $("#myModal").modal("hide");
				},
				error : function() {
					alert("error");
				}
			});
			var t = setInterval(function() {
				//下面的testMessage是自定义的。
				socket.emit('fileUpload', videoName, function() {
					output('<span> emit' + data + '</span>');
				});
			}, 500);
			//这里是监听服务端返回的testMessage事件
			socket.on('fileUpload', function(data) {
				if (data == "null" || data == null) {
					output('0');
				} else {
					output(data);
					clearInterval(t);
				}
			});
		});

	})();
</script>

</html>
